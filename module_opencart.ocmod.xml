<?xml version="1.0" encoding="utf-8"?>
<modification>
    <name>Module XLS</name>
    <code>XLS</code>
    <version>1.0</version>
    <author>Artur Legusha</author>
    <link>http://isyms.ru</link>
    <file path="admin/view/template/sale/order_form.tpl">
        <operation>
            <search trim="true|false" index="0"><![CDATA[<?php echo $button_save; ?></button>]]></search>
            <add position="after" offset="1"><![CDATA[
            <div class="text_xls">     
                <button type="button" id="button-module_xls" 
                data-loading-text="Загрузка"
                 class="btn btn-primary">
                Импорт
                </button>
            </div>    
            ]]></add>
        </operation>
    </file>  
    <file path="admin/view/template/sale/order_form.tpl">
        <operation>
            <search trim="true|false" index="0"><![CDATA[<?php echo $header; ?>]]></search>
            <add position="after" offset="1"><![CDATA[
           <link href="../admin/view/stylesheet/style_xls.css" rel="stylesheet">
    ]]></add>
        </operation>
    </file> 
    <file path="admin/view/template/sale/order_form.tpl">
        <operation>
            <search trim="true|false" index="0"><![CDATA[<?php foreach ($order_products as $order_product) { ?>]]></search>
            <add position="after" offset="1"><![CDATA[
            <div class="module_xls_product_id" style="display:none;">
                <?=$order_product['product_id']?>
            </div>    
    ]]></add>
        </operation>
    </file>
    <file path="admin/view/template/sale/order_form.tpl">
        <operation>
            <search trim="true|false" index="0"><![CDATA[html += '  <td class="text-right">' + product['quantity'] + '</td>';]]></search>
            <add position="replace" offset="0"><![CDATA[
               html += '  <td class="text-right module_xls_total_quantity">' + product['quantity'] + '</td>';
            ]]></add>
        </operation>
    </file>
    <file path="admin/view/template/sale/order_form.tpl">
        <operation>
            <search trim="true|false" index="1"><![CDATA[html += '  <td class="text-right">' + product['total'] + '</td>';]]></search>
            <add position="replace" offset="0"><![CDATA[
          html += '  <td class="text-right module_xls_total">' + product['total'] + '</td>';   
    ]]></add>
        </operation>
    </file>
     
    <file path="admin/view/template/sale/order_form.tpl">
        <operation>
            <search trim="true|false" index="0"><![CDATA[<?php echo $button_save; ?></button>]]></search>
            <add position="after" offset="1"><![CDATA[
          <script>
            $(document).ready(function(){
                /*По клику получаем нужные нам данные (ид товара, количество и общую сумму)*/
                $('#button-module_xls').click(function(){
                
                /*узнаем сколько полей с товаром в заказе для того что бы запустить цикл (Цыфру ставим взависимости 
                от количества полей в 5 пункте заказа)*/
                    var rows_table = document.getElementById('total').getElementsByTagName('tr').length - 4;
                    var product_id = [];
                    var quantity = [];
                    var total = [];
                
                /*С помощью цикла мы заносим нужные нам данные в массивы и отправляем на сервер */
                for(var i=0; i<rows_table; ++i){
                        product_id.push($.trim($('.module_xls_product_id').toArray()[i].innerHTML));
                       quantity.push($('.module_xls_total_quantity').toArray()[i].innerHTML);
                        total.push($('.module_xls_total').toArray()[i].innerHTML);
                 }       
                    $.ajax({
                       url : 'view/template/module/module_xls/module_xls.php',
                       type : 'POST',
                       dataType:'text',
                       data :{
                          product_id:product_id,
                          quantity:quantity,
                          total:total,
                          rows_table:rows_table
                        },
                        success:function(data){
                          location.href= data;
                        },
                        error:function (xhr, ajaxOptions, thrownError){
                        console.log(thrownError); //выводим ошибку
                        }  
                    }); 
                                  
                });
            });
            </script> 
    ]]></add>
        </operation>
    </file>
</modification>

